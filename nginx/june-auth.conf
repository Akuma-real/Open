# 统一认证检查（子请求）
location = /_june_auth_check {
    internal;
    proxy_pass http://127.0.0.1:4181/verify;
    proxy_set_header Host              $host;
    proxy_set_header X-Original-URI   $scheme://$host$request_uri;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP        $remote_addr;
    proxy_set_header Cookie           $http_cookie;
    proxy_set_header Authorization    $http_authorization;
    proxy_pass_request_body off;
    proxy_set_header Content-Length   "";
}

# 发起登录（聚合登录入口）：对外走本站路径，再由 Nginx 内部反代到边车
location = /_june_auth_start {
    proxy_pass http://127.0.0.1:4181/start;
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP         $remote_addr;
}

# 回调路径（聚合登录完成后回到本域，再由 Nginx 反代至边车）
location /_june_auth_callback {
    proxy_pass http://127.0.0.1:4181/callback;
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Host  $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Real-IP         $remote_addr;
}

# 站点保护段（示例：保护根路径）
location / {
    auth_request /_june_auth_check;

    # 将认证子请求返回的头映射成变量，再注入上游
    auth_request_set $auth_user   $upstream_http_x_auth_user;
    auth_request_set $auth_email  $upstream_http_x_auth_email;
    auth_request_set $auth_id     $upstream_http_x_auth_id;
    proxy_set_header X-User       $auth_user;
    proxy_set_header X-User-Email $auth_email;
    proxy_set_header X-User-Id    $auth_id;

    error_page 401 = @june_signin;

    proxy_pass http://$upstream_app;
    proxy_set_header Host $host;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
}

# 未登录跳转入口（跳本域，再由 /_june_auth_start 转发给边车）
location @june_signin {
    return 302 $scheme://$host/_june_auth_start?rd=$scheme://$host$request_uri;
}

# 可选：登出
location = /logout {
    proxy_pass http://127.0.0.1:4181/logout?rd=$scheme://$host/;
}
